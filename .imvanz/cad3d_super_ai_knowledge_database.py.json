[
  {
    "timestamp": "2025-11-21T23:25:40.040Z",
    "fileName": "cad3d\\super_ai\\knowledge_database.py",
    "content": "\"\"\"\r\nUniversity Knowledge Database\r\nپایگاه داده کامل اطلاعات دانشگاهی\r\n\r\nذخیره‌سازی ساختاریافته تمام اطلاعات جمع‌آوری‌شده\r\n\"\"\"\r\n\r\nimport sqlite3\r\nimport json\r\nfrom datetime import datetime\r\nfrom typing import Dict, List, Optional\r\nfrom pathlib import Path\r\nimport logging\r\n\r\nlogger = logging.getLogger(__name__)\r\n\r\nclass UniversityKnowledgeDB:\r\n    \"\"\"\r\n    پایگاه داده SQLite برای ذخیره اطلاعات دانشگاهی\r\n    \r\n    جداول:\r\n    - universities: اطلاعات دانشگاه‌ها\r\n    - documents: اسناد جمع‌آوری‌شده\r\n    - scraping_sessions: جلسات scraping\r\n    - security_events: رویدادهای امنیتی\r\n    - specialization_stats: آمار تخصص‌ها\r\n    \"\"\"\r\n    \r\n    def __init__(self, db_path: str = \"university_cache/knowledge.db\"):\r\n        self.db_path = Path(db_path)\r\n        self.db_path.parent.mkdir(exist_ok=True, parents=True)\r\n        \r\n        self.conn = sqlite3.connect(str(self.db_path), check_same_thread=False)\r\n        self.conn.row_factory = sqlite3.Row  # برای دسترسی ستونی\r\n        \r\n        self._create_tables()\r\n        logger.info(f\"✓ Database initialized: {self.db_path}\")\r\n    \r\n    def _create_tables(self):\r\n        \"\"\"ایجاد جداول\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        # جدول دانشگاه‌ها\r\n        cursor.execute(\"\"\"\r\n            CREATE TABLE IF NOT EXISTS universities (\r\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n                key TEXT UNIQUE NOT NULL,\r\n                name TEXT NOT NULL,\r\n                country TEXT,\r\n                rank INTEGER,\r\n                focus_areas TEXT,  -- JSON array\r\n                total_documents INTEGER DEFAULT 0,\r\n                total_pages_scraped INTEGER DEFAULT 0,\r\n                last_update TEXT,\r\n                compliance_score REAL DEFAULT 100.0,\r\n                created_at TEXT DEFAULT CURRENT_TIMESTAMP\r\n            )\r\n        \"\"\")\r\n        \r\n        # جدول اسناد\r\n        cursor.execute(\"\"\"\r\n            CREATE TABLE IF NOT EXISTS documents (\r\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n                university_key TEXT NOT NULL,\r\n                resource TEXT NOT NULL,\r\n                url TEXT,\r\n                title TEXT,\r\n                content TEXT,\r\n                content_length INTEGER,\r\n                metadata TEXT,  -- JSON\r\n                specializations TEXT,  -- JSON array\r\n                compliance_level TEXT,\r\n                scraped_at TEXT DEFAULT CURRENT_TIMESTAMP,\r\n                FOREIGN KEY (university_key) REFERENCES universities(key)\r\n            )\r\n        \"\"\")\r\n        \r\n        # جدول جلسات scraping\r\n        cursor.execute(\"\"\"\r\n            CREATE TABLE IF NOT EXISTS scraping_sessions (\r\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n                university_key TEXT NOT NULL,\r\n                pages_scraped INTEGER DEFAULT 0,\r\n                documents_collected INTEGER DEFAULT 0,\r\n                documents_accepted INTEGER DEFAULT 0,\r\n                documents_rejected INTEGER DEFAULT 0,\r\n                duration_seconds REAL,\r\n                status TEXT,  -- success/failed\r\n                error_message TEXT,\r\n                started_at TEXT,\r\n                completed_at TEXT,\r\n                FOREIGN KEY (university_key) REFERENCES universities(key)\r\n            )\r\n        \"\"\")\r\n        \r\n        # جدول رویدادهای امنیتی\r\n        cursor.execute(\"\"\"\r\n            CREATE TABLE IF NOT EXISTS security_events (\r\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n                university_key TEXT,\r\n                event_type TEXT NOT NULL,\r\n                severity TEXT,  -- info/warning/violation/blocked\r\n                message TEXT,\r\n                metadata TEXT,  -- JSON\r\n                created_at TEXT DEFAULT CURRENT_TIMESTAMP\r\n            )\r\n        \"\"\")\r\n        \r\n        # جدول آمار تخصص‌ها\r\n        cursor.execute(\"\"\"\r\n            CREATE TABLE IF NOT EXISTS specialization_stats (\r\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n                field TEXT NOT NULL,\r\n                subfield TEXT,\r\n                document_count INTEGER DEFAULT 0,\r\n                last_updated TEXT DEFAULT CURRENT_TIMESTAMP,\r\n                UNIQUE(field, subfield)\r\n            )\r\n        \"\"\")\r\n        \r\n        # ایندکس‌ها برای سرعت\r\n        cursor.execute(\"CREATE INDEX IF NOT EXISTS idx_docs_university ON documents(university_key)\")\r\n        cursor.execute(\"CREATE INDEX IF NOT EXISTS idx_docs_scraped ON documents(scraped_at)\")\r\n        cursor.execute(\"CREATE INDEX IF NOT EXISTS idx_sessions_university ON scraping_sessions(university_key)\")\r\n        cursor.execute(\"CREATE INDEX IF NOT EXISTS idx_security_university ON security_events(university_key)\")\r\n        \r\n        self.conn.commit()\r\n    \r\n    def add_university(self, key: str, info: Dict) -> int:\r\n        \"\"\"افزودن یا به‌روزرسانی دانشگاه\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            INSERT INTO universities (key, name, country, rank, focus_areas)\r\n            VALUES (?, ?, ?, ?, ?)\r\n            ON CONFLICT(key) DO UPDATE SET\r\n                name = excluded.name,\r\n                country = excluded.country,\r\n                rank = excluded.rank,\r\n                focus_areas = excluded.focus_areas\r\n        \"\"\", (\r\n            key,\r\n            info['name'],\r\n            info['country'],\r\n            info['rank'],\r\n            json.dumps(info['focus_areas'])\r\n        ))\r\n        \r\n        self.conn.commit()\r\n        return cursor.lastrowid\r\n    \r\n    def add_document(self, doc: Dict, university_key: str, compliance_level: str) -> int:\r\n        \"\"\"افزودن سند\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        metadata = doc.get('metadata', {})\r\n        \r\n        cursor.execute(\"\"\"\r\n            INSERT INTO documents (\r\n                university_key, resource, url, title, content,\r\n                content_length, metadata, compliance_level\r\n            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)\r\n        \"\"\", (\r\n            university_key,\r\n            metadata.get('resource', 'unknown'),\r\n            metadata.get('url', ''),\r\n            doc.get('title', 'Untitled'),\r\n            doc.get('content', ''),\r\n            len(doc.get('content', '')),\r\n            json.dumps(metadata),\r\n            compliance_level\r\n        ))\r\n        \r\n        # به‌روزرسانی شمارنده دانشگاه\r\n        cursor.execute(\"\"\"\r\n            UPDATE universities\r\n            SET total_documents = total_documents + 1\r\n            WHERE key = ?\r\n        \"\"\", (university_key,))\r\n        \r\n        self.conn.commit()\r\n        return cursor.lastrowid\r\n    \r\n    def start_scraping_session(self, university_key: str) -> int:\r\n        \"\"\"شروع جلسه scraping\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            INSERT INTO scraping_sessions (university_key, started_at)\r\n            VALUES (?, ?)\r\n        \"\"\", (university_key, datetime.now().isoformat()))\r\n        \r\n        self.conn.commit()\r\n        return cursor.lastrowid\r\n    \r\n    def complete_scraping_session(\r\n        self,\r\n        session_id: int,\r\n        pages: int,\r\n        collected: int,\r\n        accepted: int,\r\n        rejected: int,\r\n        duration: float,\r\n        status: str,\r\n        error: Optional[str] = None\r\n    ):\r\n        \"\"\"اتمام جلسه scraping\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            UPDATE scraping_sessions SET\r\n                pages_scraped = ?,\r\n                documents_collected = ?,\r\n                documents_accepted = ?,\r\n                documents_rejected = ?,\r\n                duration_seconds = ?,\r\n                status = ?,\r\n                error_message = ?,\r\n                completed_at = ?\r\n            WHERE id = ?\r\n        \"\"\", (\r\n            pages, collected, accepted, rejected,\r\n            duration, status, error,\r\n            datetime.now().isoformat(),\r\n            session_id\r\n        ))\r\n        \r\n        self.conn.commit()\r\n    \r\n    def log_security_event(self, university_key: str, event_type: str, severity: str, message: str, metadata: Dict):\r\n        \"\"\"ثبت رویداد امنیتی\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            INSERT INTO security_events (university_key, event_type, severity, message, metadata)\r\n            VALUES (?, ?, ?, ?, ?)\r\n        \"\"\", (\r\n            university_key, event_type, severity, message, json.dumps(metadata)\r\n        ))\r\n        \r\n        self.conn.commit()\r\n    \r\n    def update_specialization_stats(self, field: str, subfield: str, count: int = 1):\r\n        \"\"\"به‌روزرسانی آمار تخصص\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            INSERT INTO specialization_stats (field, subfield, document_count)\r\n            VALUES (?, ?, ?)\r\n            ON CONFLICT(field, subfield) DO UPDATE SET\r\n                document_count = document_count + ?,\r\n                last_updated = CURRENT_TIMESTAMP\r\n        \"\"\", (field, subfield, count, count))\r\n        \r\n        self.conn.commit()\r\n    \r\n    def get_university_stats(self, university_key: str) -> Dict:\r\n        \"\"\"آمار یک دانشگاه\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        # اطلاعات اصلی\r\n        cursor.execute(\"\"\"\r\n            SELECT * FROM universities WHERE key = ?\r\n        \"\"\", (university_key,))\r\n        \r\n        uni = cursor.fetchone()\r\n        if not uni:\r\n            return {}\r\n        \r\n        # آمار اسناد\r\n        cursor.execute(\"\"\"\r\n            SELECT \r\n                COUNT(*) as total,\r\n                SUM(content_length) as total_chars,\r\n                AVG(content_length) as avg_chars\r\n            FROM documents WHERE university_key = ?\r\n        \"\"\", (university_key,))\r\n        doc_stats = cursor.fetchone()\r\n        \r\n        # آمار جلسات\r\n        cursor.execute(\"\"\"\r\n            SELECT \r\n                COUNT(*) as sessions,\r\n                SUM(pages_scraped) as total_pages,\r\n                AVG(duration_seconds) as avg_duration\r\n            FROM scraping_sessions WHERE university_key = ?\r\n        \"\"\", (university_key,))\r\n        session_stats = cursor.fetchone()\r\n        \r\n        return {\r\n            'university': dict(uni),\r\n            'documents': dict(doc_stats),\r\n            'sessions': dict(session_stats)\r\n        }\r\n    \r\n    def get_all_universities_summary(self) -> List[Dict]:\r\n        \"\"\"خلاصه همه دانشگاه‌ها\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            SELECT \r\n                u.*,\r\n                COUNT(d.id) as doc_count,\r\n                SUM(d.content_length) as total_content\r\n            FROM universities u\r\n            LEFT JOIN documents d ON u.key = d.university_key\r\n            GROUP BY u.id\r\n            ORDER BY u.rank\r\n        \"\"\")\r\n        \r\n        return [dict(row) for row in cursor.fetchall()]\r\n    \r\n    def get_specialization_coverage(self) -> Dict:\r\n        \"\"\"پوشش تخصص‌ها\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            SELECT field, SUM(document_count) as total\r\n            FROM specialization_stats\r\n            GROUP BY field\r\n            ORDER BY total DESC\r\n        \"\"\")\r\n        \r\n        return {row['field']: row['total'] for row in cursor.fetchall()}\r\n    \r\n    def get_security_summary(self) -> Dict:\r\n        \"\"\"خلاصه امنیتی\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            SELECT \r\n                severity,\r\n                COUNT(*) as count\r\n            FROM security_events\r\n            GROUP BY severity\r\n        \"\"\")\r\n        \r\n        severity_counts = {row['severity']: row['count'] for row in cursor.fetchall()}\r\n        \r\n        cursor.execute(\"\"\"\r\n            SELECT COUNT(*) as total FROM security_events\r\n        \"\"\")\r\n        total = cursor.fetchone()['total']\r\n        \r\n        return {\r\n            'total_events': total,\r\n            'by_severity': severity_counts\r\n        }\r\n    \r\n    def close(self):\r\n        \"\"\"بستن اتصال\"\"\"\r\n        self.conn.close()\r\n",
    "format": "py"
  },
  {
    "timestamp": "2025-11-21T23:25:40.735Z",
    "fileName": "cad3d\\super_ai\\knowledge_database.py",
    "content": "\"\"\"\r\nUniversity Knowledge Database\r\nپایگاه داده کامل اطلاعات دانشگاهی\r\n\r\nذخیره‌سازی ساختاریافته تمام اطلاعات جمع‌آوری‌شده\r\n\"\"\"\r\n\r\nimport sqlite3\r\nimport json\r\nfrom datetime import datetime\r\nfrom typing import Dict, List, Optional\r\nfrom pathlib import Path\r\nimport logging\r\n\r\nlogger = logging.getLogger(__name__)\r\n\r\nclass UniversityKnowledgeDB:\r\n    \"\"\"\r\n    پایگاه داده SQLite برای ذخیره اطلاعات دانشگاهی\r\n    \r\n    جداول:\r\n    - universities: اطلاعات دانشگاه‌ها\r\n    - documents: اسناد جمع‌آوری‌شده\r\n    - scraping_sessions: جلسات scraping\r\n    - security_events: رویدادهای امنیتی\r\n    - specialization_stats: آمار تخصص‌ها\r\n    \"\"\"\r\n    \r\n    def __init__(self, db_path: str = \"university_cache/knowledge.db\"):\r\n        self.db_path = Path(db_path)\r\n        self.db_path.parent.mkdir(exist_ok=True, parents=True)\r\n        \r\n        self.conn = sqlite3.connect(str(self.db_path), check_same_thread=False)\r\n        self.conn.row_factory = sqlite3.Row  # برای دسترسی ستونی\r\n        \r\n        self._create_tables()\r\n        logger.info(f\"✓ Database initialized: {self.db_path}\")\r\n    \r\n    def _create_tables(self):\r\n        \"\"\"ایجاد جداول\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        # جدول دانشگاه‌ها\r\n        cursor.execute(\"\"\"\r\n            CREATE TABLE IF NOT EXISTS universities (\r\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n                key TEXT UNIQUE NOT NULL,\r\n                name TEXT NOT NULL,\r\n                country TEXT,\r\n                rank INTEGER,\r\n                focus_areas TEXT,  -- JSON array\r\n                total_documents INTEGER DEFAULT 0,\r\n                total_pages_scraped INTEGER DEFAULT 0,\r\n                last_update TEXT,\r\n                compliance_score REAL DEFAULT 100.0,\r\n                created_at TEXT DEFAULT CURRENT_TIMESTAMP\r\n            )\r\n        \"\"\")\r\n        \r\n        # جدول اسناد\r\n        cursor.execute(\"\"\"\r\n            CREATE TABLE IF NOT EXISTS documents (\r\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n                university_key TEXT NOT NULL,\r\n                resource TEXT NOT NULL,\r\n                url TEXT,\r\n                title TEXT,\r\n                content TEXT,\r\n                content_length INTEGER,\r\n                metadata TEXT,  -- JSON\r\n                specializations TEXT,  -- JSON array\r\n                compliance_level TEXT,\r\n                scraped_at TEXT DEFAULT CURRENT_TIMESTAMP,\r\n                FOREIGN KEY (university_key) REFERENCES universities(key)\r\n            )\r\n        \"\"\")\r\n        \r\n        # جدول جلسات scraping\r\n        cursor.execute(\"\"\"\r\n            CREATE TABLE IF NOT EXISTS scraping_sessions (\r\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n                university_key TEXT NOT NULL,\r\n                pages_scraped INTEGER DEFAULT 0,\r\n                documents_collected INTEGER DEFAULT 0,\r\n                documents_accepted INTEGER DEFAULT 0,\r\n                documents_rejected INTEGER DEFAULT 0,\r\n                duration_seconds REAL,\r\n                status TEXT,  -- success/failed\r\n                error_message TEXT,\r\n                started_at TEXT,\r\n                completed_at TEXT,\r\n                FOREIGN KEY (university_key) REFERENCES universities(key)\r\n            )\r\n        \"\"\")\r\n        \r\n        # جدول رویدادهای امنیتی\r\n        cursor.execute(\"\"\"\r\n            CREATE TABLE IF NOT EXISTS security_events (\r\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n                university_key TEXT,\r\n                event_type TEXT NOT NULL,\r\n                severity TEXT,  -- info/warning/violation/blocked\r\n                message TEXT,\r\n                metadata TEXT,  -- JSON\r\n                created_at TEXT DEFAULT CURRENT_TIMESTAMP\r\n            )\r\n        \"\"\")\r\n        \r\n        # جدول آمار تخصص‌ها\r\n        cursor.execute(\"\"\"\r\n            CREATE TABLE IF NOT EXISTS specialization_stats (\r\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n                field TEXT NOT NULL,\r\n                subfield TEXT,\r\n                document_count INTEGER DEFAULT 0,\r\n                last_updated TEXT DEFAULT CURRENT_TIMESTAMP,\r\n                UNIQUE(field, subfield)\r\n            )\r\n        \"\"\")\r\n        \r\n        # ایندکس‌ها برای سرعت\r\n        cursor.execute(\"CREATE INDEX IF NOT EXISTS idx_docs_university ON documents(university_key)\")\r\n        cursor.execute(\"CREATE INDEX IF NOT EXISTS idx_docs_scraped ON documents(scraped_at)\")\r\n        cursor.execute(\"CREATE INDEX IF NOT EXISTS idx_sessions_university ON scraping_sessions(university_key)\")\r\n        cursor.execute(\"CREATE INDEX IF NOT EXISTS idx_security_university ON security_events(university_key)\")\r\n        \r\n        self.conn.commit()\r\n    \r\n    def add_university(self, key: str, info: Dict) -> int:\r\n        \"\"\"افزودن یا به‌روزرسانی دانشگاه\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            INSERT INTO universities (key, name, country, rank, focus_areas)\r\n            VALUES (?, ?, ?, ?, ?)\r\n            ON CONFLICT(key) DO UPDATE SET\r\n                name = excluded.name,\r\n                country = excluded.country,\r\n                rank = excluded.rank,\r\n                focus_areas = excluded.focus_areas\r\n        \"\"\", (\r\n            key,\r\n            info['name'],\r\n            info['country'],\r\n            info['rank'],\r\n            json.dumps(info['focus_areas'])\r\n        ))\r\n        \r\n        self.conn.commit()\r\n        return cursor.lastrowid\r\n    \r\n    def add_document(self, doc: Dict, university_key: str, compliance_level: str) -> int:\r\n        \"\"\"افزودن سند\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        metadata = doc.get('metadata', {})\r\n        \r\n        cursor.execute(\"\"\"\r\n            INSERT INTO documents (\r\n                university_key, resource, url, title, content,\r\n                content_length, metadata, compliance_level\r\n            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)\r\n        \"\"\", (\r\n            university_key,\r\n            metadata.get('resource', 'unknown'),\r\n            metadata.get('url', ''),\r\n            doc.get('title', 'Untitled'),\r\n            doc.get('content', ''),\r\n            len(doc.get('content', '')),\r\n            json.dumps(metadata),\r\n            compliance_level\r\n        ))\r\n        \r\n        # به‌روزرسانی شمارنده دانشگاه\r\n        cursor.execute(\"\"\"\r\n            UPDATE universities\r\n            SET total_documents = total_documents + 1\r\n            WHERE key = ?\r\n        \"\"\", (university_key,))\r\n        \r\n        self.conn.commit()\r\n        return cursor.lastrowid\r\n    \r\n    def start_scraping_session(self, university_key: str) -> int:\r\n        \"\"\"شروع جلسه scraping\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            INSERT INTO scraping_sessions (university_key, started_at)\r\n            VALUES (?, ?)\r\n        \"\"\", (university_key, datetime.now().isoformat()))\r\n        \r\n        self.conn.commit()\r\n        return cursor.lastrowid\r\n    \r\n    def complete_scraping_session(\r\n        self,\r\n        session_id: int,\r\n        pages: int,\r\n        collected: int,\r\n        accepted: int,\r\n        rejected: int,\r\n        duration: float,\r\n        status: str,\r\n        error: Optional[str] = None\r\n    ):\r\n        \"\"\"اتمام جلسه scraping\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            UPDATE scraping_sessions SET\r\n                pages_scraped = ?,\r\n                documents_collected = ?,\r\n                documents_accepted = ?,\r\n                documents_rejected = ?,\r\n                duration_seconds = ?,\r\n                status = ?,\r\n                error_message = ?,\r\n                completed_at = ?\r\n            WHERE id = ?\r\n        \"\"\", (\r\n            pages, collected, accepted, rejected,\r\n            duration, status, error,\r\n            datetime.now().isoformat(),\r\n            session_id\r\n        ))\r\n        \r\n        self.conn.commit()\r\n    \r\n    def log_security_event(self, university_key: str, event_type: str, severity: str, message: str, metadata: Dict):\r\n        \"\"\"ثبت رویداد امنیتی\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            INSERT INTO security_events (university_key, event_type, severity, message, metadata)\r\n            VALUES (?, ?, ?, ?, ?)\r\n        \"\"\", (\r\n            university_key, event_type, severity, message, json.dumps(metadata)\r\n        ))\r\n        \r\n        self.conn.commit()\r\n    \r\n    def update_specialization_stats(self, field: str, subfield: str, count: int = 1):\r\n        \"\"\"به‌روزرسانی آمار تخصص\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            INSERT INTO specialization_stats (field, subfield, document_count)\r\n            VALUES (?, ?, ?)\r\n            ON CONFLICT(field, subfield) DO UPDATE SET\r\n                document_count = document_count + ?,\r\n                last_updated = CURRENT_TIMESTAMP\r\n        \"\"\", (field, subfield, count, count))\r\n        \r\n        self.conn.commit()\r\n    \r\n    def get_university_stats(self, university_key: str) -> Dict:\r\n        \"\"\"آمار یک دانشگاه\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        # اطلاعات اصلی\r\n        cursor.execute(\"\"\"\r\n            SELECT * FROM universities WHERE key = ?\r\n        \"\"\", (university_key,))\r\n        \r\n        uni = cursor.fetchone()\r\n        if not uni:\r\n            return {}\r\n        \r\n        # آمار اسناد\r\n        cursor.execute(\"\"\"\r\n            SELECT \r\n                COUNT(*) as total,\r\n                SUM(content_length) as total_chars,\r\n                AVG(content_length) as avg_chars\r\n            FROM documents WHERE university_key = ?\r\n        \"\"\", (university_key,))\r\n        doc_stats = cursor.fetchone()\r\n        \r\n        # آمار جلسات\r\n        cursor.execute(\"\"\"\r\n            SELECT \r\n                COUNT(*) as sessions,\r\n                SUM(pages_scraped) as total_pages,\r\n                AVG(duration_seconds) as avg_duration\r\n            FROM scraping_sessions WHERE university_key = ?\r\n        \"\"\", (university_key,))\r\n        session_stats = cursor.fetchone()\r\n        \r\n        return {\r\n            'university': dict(uni),\r\n            'documents': dict(doc_stats),\r\n            'sessions': dict(session_stats)\r\n        }\r\n    \r\n    def get_all_universities_summary(self) -> List[Dict]:\r\n        \"\"\"خلاصه همه دانشگاه‌ها\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            SELECT \r\n                u.*,\r\n                COUNT(d.id) as doc_count,\r\n                SUM(d.content_length) as total_content\r\n            FROM universities u\r\n            LEFT JOIN documents d ON u.key = d.university_key\r\n            GROUP BY u.id\r\n            ORDER BY u.rank\r\n        \"\"\")\r\n        \r\n        return [dict(row) for row in cursor.fetchall()]\r\n    \r\n    def get_specialization_coverage(self) -> Dict:\r\n        \"\"\"پوشش تخصص‌ها\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            SELECT field, SUM(document_count) as total\r\n            FROM specialization_stats\r\n            GROUP BY field\r\n            ORDER BY total DESC\r\n        \"\"\")\r\n        \r\n        return {row['field']: row['total'] for row in cursor.fetchall()}\r\n    \r\n    def get_security_summary(self) -> Dict:\r\n        \"\"\"خلاصه امنیتی\"\"\"\r\n        cursor = self.conn.cursor()\r\n        \r\n        cursor.execute(\"\"\"\r\n            SELECT \r\n                severity,\r\n                COUNT(*) as count\r\n            FROM security_events\r\n            GROUP BY severity\r\n        \"\"\")\r\n        \r\n        severity_counts = {row['severity']: row['count'] for row in cursor.fetchall()}\r\n        \r\n        cursor.execute(\"\"\"\r\n            SELECT COUNT(*) as total FROM security_events\r\n        \"\"\")\r\n        total = cursor.fetchone()['total']\r\n        \r\n        return {\r\n            'total_events': total,\r\n            'by_severity': severity_counts\r\n        }\r\n    \r\n    def close(self):\r\n        \"\"\"بستن اتصال\"\"\"\r\n        self.conn.close()\r\n",
    "format": "py"
  }
]