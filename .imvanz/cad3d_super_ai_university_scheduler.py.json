[
  {
    "timestamp": "2025-11-21T23:15:42.759Z",
    "fileName": "cad3d\\super_ai\\university_scheduler.py",
    "content": "\"\"\"\r\nUniversity Learning Scheduler - زمان‌بند یادگیری خودکار\r\n\r\nسیستم زمان‌بندی برای به‌روزرسانی خودکار دانش از دانشگاه‌ها\r\n\"\"\"\r\n\r\nimport schedule\r\nimport time\r\nimport logging\r\nfrom datetime import datetime\r\nfrom typing import Callable, Dict\r\nfrom pathlib import Path\r\nimport json\r\nimport threading\r\n\r\nfrom .university_agents import UniversityAgentManager\r\nfrom .university_config import UNIVERSITIES, AGENT_CONFIG\r\n\r\nlogger = logging.getLogger(__name__)\r\n\r\nclass UniversityLearningScheduler:\r\n    \"\"\"\r\n    Scheduler برای یادگیری خودکار و دوره‌ای\r\n    \r\n    ویژگی‌ها:\r\n    - یادگیری روزانه/هفتگی/ماهانه\r\n    - اولویت‌بندی دانشگاه‌ها\r\n    - مدیریت خطا و تلاش مجدد\r\n    - گزارش‌دهی\r\n    \"\"\"\r\n    \r\n    def __init__(self, agent_manager: UniversityAgentManager):\r\n        self.agent_manager = agent_manager\r\n        self.is_running = False\r\n        self.scheduler_thread = None\r\n        \r\n        # Schedule configuration\r\n        self.schedules = {\r\n            'daily': [],      # لیست دانشگاه‌هایی که روزانه چک می‌شوند\r\n            'weekly': [],     # هفتگی\r\n            'monthly': []     # ماهانه\r\n        }\r\n        \r\n        # Logs\r\n        self.logs_dir = Path(AGENT_CONFIG['storage']['cache_dir']) / 'scheduler_logs'\r\n        self.logs_dir.mkdir(exist_ok=True, parents=True)\r\n    \r\n    def add_university_schedule(\r\n        self,\r\n        university_key: str,\r\n        frequency: str = 'daily',\r\n        time_of_day: str = '02:00'\r\n    ):\r\n        \"\"\"\r\n        افزودن زمان‌بندی برای یک دانشگاه\r\n        \r\n        Args:\r\n            university_key: کلید دانشگاه\r\n            frequency: تناوب ('daily', 'weekly', 'monthly')\r\n            time_of_day: ساعت اجرا (مثلا '02:00')\r\n        \"\"\"\r\n        if frequency not in self.schedules:\r\n            logger.error(f\"Invalid frequency: {frequency}\")\r\n            return\r\n        \r\n        self.schedules[frequency].append({\r\n            'university_key': university_key,\r\n            'time': time_of_day\r\n        })\r\n        \r\n        logger.info(f\"✓ Scheduled {university_key} for {frequency} updates at {time_of_day}\")\r\n    \r\n    def setup_default_schedules(self):\r\n        \"\"\"تنظیم زمان‌بندی پیش‌فرض برای همه دانشگاه‌ها\"\"\"\r\n        \r\n        # Top 5: Daily updates\r\n        top_5 = [\"MIT\", \"Stanford\", \"Cambridge\", \"Oxford\", \"Berkeley\"]\r\n        for uni in top_5:\r\n            self.add_university_schedule(uni, 'daily', '02:00')\r\n        \r\n        # Next 5: Weekly updates\r\n        next_5 = [\"ETH_Zurich\", \"Caltech\", \"Imperial\", \"Carnegie_Mellon\", \"TU_Delft\"]\r\n        for uni in next_5:\r\n            self.add_university_schedule(uni, 'weekly', '03:00')\r\n        \r\n        logger.info(f\"\\n✓ Default schedules configured:\")\r\n        logger.info(f\"  Daily: {len(self.schedules['daily'])} universities\")\r\n        logger.info(f\"  Weekly: {len(self.schedules['weekly'])} universities\")\r\n    \r\n    def _learning_job(self, university_keys: list):\r\n        \"\"\"\r\n        Job برای یادگیری\r\n        \r\n        Args:\r\n            university_keys: لیست دانشگاه‌ها\r\n        \"\"\"\r\n        logger.info(f\"\\n{'='*80}\")\r\n        logger.info(f\"Scheduled Learning Job: {datetime.now()}\")\r\n        logger.info(f\"Universities: {', '.join(university_keys)}\")\r\n        logger.info(f\"{'='*80}\\n\")\r\n        \r\n        try:\r\n            result = self.agent_manager.learn_from_specific(university_keys)\r\n            \r\n            # ذخیره لاگ\r\n            self._save_log({\r\n                'timestamp': datetime.now().isoformat(),\r\n                'universities': university_keys,\r\n                'status': 'success',\r\n                'result': result\r\n            })\r\n            \r\n            logger.info(f\"\\n✓ Learning job completed\")\r\n            logger.info(f\"  Agents updated: {result['agents_updated']}\")\r\n            logger.info(f\"  Total documents: {sum(r.get('documents_added_to_rag', 0) for r in result['results'])}\")\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"✗ Learning job failed: {e}\")\r\n            \r\n            # ذخیره لاگ خطا\r\n            self._save_log({\r\n                'timestamp': datetime.now().isoformat(),\r\n                'universities': university_keys,\r\n                'status': 'failed',\r\n                'error': str(e)\r\n            })\r\n    \r\n    def _save_log(self, log_data: Dict):\r\n        \"\"\"ذخیره لاگ\"\"\"\r\n        log_file = self.logs_dir / f\"{datetime.now().strftime('%Y%m%d_%H%M%S')}.json\"\r\n        \r\n        with open(log_file, 'w', encoding='utf-8') as f:\r\n            json.dump(log_data, f, ensure_ascii=False, indent=2)\r\n    \r\n    def start(self):\r\n        \"\"\"شروع scheduler\"\"\"\r\n        if self.is_running:\r\n            logger.warning(\"Scheduler already running\")\r\n            return\r\n        \r\n        logger.info(\"\\n\" + \"=\"*80)\r\n        logger.info(\"  STARTING UNIVERSITY LEARNING SCHEDULER\")\r\n        logger.info(\"=\"*80 + \"\\n\")\r\n        \r\n        # تنظیم job‌ها\r\n        \r\n        # Daily jobs\r\n        for item in self.schedules['daily']:\r\n            schedule.every().day.at(item['time']).do(\r\n                self._learning_job,\r\n                [item['university_key']]\r\n            )\r\n            logger.info(f\"  Daily: {item['university_key']} at {item['time']}\")\r\n        \r\n        # Weekly jobs (Sundays)\r\n        for item in self.schedules['weekly']:\r\n            schedule.every().sunday.at(item['time']).do(\r\n                self._learning_job,\r\n                [item['university_key']]\r\n            )\r\n            logger.info(f\"  Weekly: {item['university_key']} on Sundays at {item['time']}\")\r\n        \r\n        # Monthly jobs (1st of each month)\r\n        for item in self.schedules['monthly']:\r\n            schedule.every().month.at(item['time']).do(\r\n                self._learning_job,\r\n                [item['university_key']]\r\n            )\r\n            logger.info(f\"  Monthly: {item['university_key']} on 1st at {item['time']}\")\r\n        \r\n        logger.info(f\"\\n✓ Scheduler configured\")\r\n        logger.info(f\"  Total jobs: {len(schedule.get_jobs())}\")\r\n        \r\n        # شروع thread\r\n        self.is_running = True\r\n        self.scheduler_thread = threading.Thread(target=self._run_scheduler, daemon=True)\r\n        self.scheduler_thread.start()\r\n        \r\n        logger.info(f\"✓ Scheduler started in background thread\\n\")\r\n    \r\n    def _run_scheduler(self):\r\n        \"\"\"Loop اصلی scheduler\"\"\"\r\n        while self.is_running:\r\n            schedule.run_pending()\r\n            time.sleep(60)  # بررسی هر دقیقه\r\n    \r\n    def stop(self):\r\n        \"\"\"توقف scheduler\"\"\"\r\n        logger.info(\"\\nStopping scheduler...\")\r\n        self.is_running = False\r\n        \r\n        if self.scheduler_thread:\r\n            self.scheduler_thread.join(timeout=5)\r\n        \r\n        schedule.clear()\r\n        logger.info(\"✓ Scheduler stopped\\n\")\r\n    \r\n    def run_now(self, university_keys: list):\r\n        \"\"\"اجرای فوری یک job\"\"\"\r\n        logger.info(f\"\\nRunning immediate learning job...\")\r\n        self._learning_job(university_keys)\r\n    \r\n    def get_next_runs(self) -> list:\r\n        \"\"\"زمان اجرای بعدی job‌ها\"\"\"\r\n        jobs = schedule.get_jobs()\r\n        \r\n        next_runs = []\r\n        for job in jobs:\r\n            next_runs.append({\r\n                'job': str(job.job_func),\r\n                'next_run': job.next_run.isoformat() if job.next_run else None\r\n            })\r\n        \r\n        return next_runs\r\n    \r\n    def get_logs(self, limit: int = 10) -> list:\r\n        \"\"\"دریافت آخرین لاگ‌ها\"\"\"\r\n        log_files = sorted(self.logs_dir.glob('*.json'), reverse=True)[:limit]\r\n        \r\n        logs = []\r\n        for log_file in log_files:\r\n            with open(log_file, 'r', encoding='utf-8') as f:\r\n                logs.append(json.load(f))\r\n        \r\n        return logs\r\n\r\n\r\ndef demo_scheduler():\r\n    \"\"\"دمو scheduler\"\"\"\r\n    from .rag_system import RAGSystem\r\n    \r\n    logger.info(\"\\n\" + \"=\"*80)\r\n    logger.info(\"  SCHEDULER DEMO\")\r\n    logger.info(\"=\"*80 + \"\\n\")\r\n    \r\n    # Initialize\r\n    rag_system = RAGSystem()\r\n    agent_manager = UniversityAgentManager(UNIVERSITIES, AGENT_CONFIG, rag_system)\r\n    scheduler = UniversityLearningScheduler(agent_manager)\r\n    \r\n    # تنظیم زمان‌بندی پیش‌فرض\r\n    scheduler.setup_default_schedules()\r\n    \r\n    # نمایش job‌های بعدی\r\n    logger.info(\"\\nNext scheduled runs:\")\r\n    next_runs = scheduler.get_next_runs()\r\n    for run in next_runs[:5]:\r\n        logger.info(f\"  {run['job']}: {run['next_run']}\")\r\n    \r\n    # اجرای فوری یک job برای تست\r\n    logger.info(\"\\n\\nRunning immediate test job (MIT)...\")\r\n    scheduler.run_now(['MIT'])\r\n    \r\n    # نمایش لاگ‌ها\r\n    logger.info(\"\\n\\nRecent logs:\")\r\n    logs = scheduler.get_logs(limit=3)\r\n    for log in logs:\r\n        logger.info(f\"\\n  {log['timestamp']}:\")\r\n        logger.info(f\"    Status: {log['status']}\")\r\n        logger.info(f\"    Universities: {', '.join(log['universities'])}\")\r\n    \r\n    logger.info(\"\\n\" + \"=\"*80)\r\n    logger.info(\"  SCHEDULER DEMO COMPLETE\")\r\n    logger.info(\"=\"*80 + \"\\n\")\r\n    \r\n    logger.info(\"To run scheduler continuously:\")\r\n    logger.info(\"  scheduler.start()\")\r\n    logger.info(\"  # Runs in background thread\")\r\n    logger.info(\"  # Press Ctrl+C to stop\")\r\n    logger.info(\"\")\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    # Setup logging\r\n    logging.basicConfig(\r\n        level=logging.INFO,\r\n        format='%(message)s'\r\n    )\r\n    \r\n    demo_scheduler()\r\n",
    "format": "py"
  },
  {
    "timestamp": "2025-11-21T23:15:42.926Z",
    "fileName": "cad3d\\super_ai\\university_scheduler.py",
    "content": "\"\"\"\r\nUniversity Learning Scheduler - زمان‌بند یادگیری خودکار\r\n\r\nسیستم زمان‌بندی برای به‌روزرسانی خودکار دانش از دانشگاه‌ها\r\n\"\"\"\r\n\r\nimport schedule\r\nimport time\r\nimport logging\r\nfrom datetime import datetime\r\nfrom typing import Callable, Dict\r\nfrom pathlib import Path\r\nimport json\r\nimport threading\r\n\r\nfrom .university_agents import UniversityAgentManager\r\nfrom .university_config import UNIVERSITIES, AGENT_CONFIG\r\n\r\nlogger = logging.getLogger(__name__)\r\n\r\nclass UniversityLearningScheduler:\r\n    \"\"\"\r\n    Scheduler برای یادگیری خودکار و دوره‌ای\r\n    \r\n    ویژگی‌ها:\r\n    - یادگیری روزانه/هفتگی/ماهانه\r\n    - اولویت‌بندی دانشگاه‌ها\r\n    - مدیریت خطا و تلاش مجدد\r\n    - گزارش‌دهی\r\n    \"\"\"\r\n    \r\n    def __init__(self, agent_manager: UniversityAgentManager):\r\n        self.agent_manager = agent_manager\r\n        self.is_running = False\r\n        self.scheduler_thread = None\r\n        \r\n        # Schedule configuration\r\n        self.schedules = {\r\n            'daily': [],      # لیست دانشگاه‌هایی که روزانه چک می‌شوند\r\n            'weekly': [],     # هفتگی\r\n            'monthly': []     # ماهانه\r\n        }\r\n        \r\n        # Logs\r\n        self.logs_dir = Path(AGENT_CONFIG['storage']['cache_dir']) / 'scheduler_logs'\r\n        self.logs_dir.mkdir(exist_ok=True, parents=True)\r\n    \r\n    def add_university_schedule(\r\n        self,\r\n        university_key: str,\r\n        frequency: str = 'daily',\r\n        time_of_day: str = '02:00'\r\n    ):\r\n        \"\"\"\r\n        افزودن زمان‌بندی برای یک دانشگاه\r\n        \r\n        Args:\r\n            university_key: کلید دانشگاه\r\n            frequency: تناوب ('daily', 'weekly', 'monthly')\r\n            time_of_day: ساعت اجرا (مثلا '02:00')\r\n        \"\"\"\r\n        if frequency not in self.schedules:\r\n            logger.error(f\"Invalid frequency: {frequency}\")\r\n            return\r\n        \r\n        self.schedules[frequency].append({\r\n            'university_key': university_key,\r\n            'time': time_of_day\r\n        })\r\n        \r\n        logger.info(f\"✓ Scheduled {university_key} for {frequency} updates at {time_of_day}\")\r\n    \r\n    def setup_default_schedules(self):\r\n        \"\"\"تنظیم زمان‌بندی پیش‌فرض برای همه دانشگاه‌ها\"\"\"\r\n        \r\n        # Top 5: Daily updates\r\n        top_5 = [\"MIT\", \"Stanford\", \"Cambridge\", \"Oxford\", \"Berkeley\"]\r\n        for uni in top_5:\r\n            self.add_university_schedule(uni, 'daily', '02:00')\r\n        \r\n        # Next 5: Weekly updates\r\n        next_5 = [\"ETH_Zurich\", \"Caltech\", \"Imperial\", \"Carnegie_Mellon\", \"TU_Delft\"]\r\n        for uni in next_5:\r\n            self.add_university_schedule(uni, 'weekly', '03:00')\r\n        \r\n        logger.info(f\"\\n✓ Default schedules configured:\")\r\n        logger.info(f\"  Daily: {len(self.schedules['daily'])} universities\")\r\n        logger.info(f\"  Weekly: {len(self.schedules['weekly'])} universities\")\r\n    \r\n    def _learning_job(self, university_keys: list):\r\n        \"\"\"\r\n        Job برای یادگیری\r\n        \r\n        Args:\r\n            university_keys: لیست دانشگاه‌ها\r\n        \"\"\"\r\n        logger.info(f\"\\n{'='*80}\")\r\n        logger.info(f\"Scheduled Learning Job: {datetime.now()}\")\r\n        logger.info(f\"Universities: {', '.join(university_keys)}\")\r\n        logger.info(f\"{'='*80}\\n\")\r\n        \r\n        try:\r\n            result = self.agent_manager.learn_from_specific(university_keys)\r\n            \r\n            # ذخیره لاگ\r\n            self._save_log({\r\n                'timestamp': datetime.now().isoformat(),\r\n                'universities': university_keys,\r\n                'status': 'success',\r\n                'result': result\r\n            })\r\n            \r\n            logger.info(f\"\\n✓ Learning job completed\")\r\n            logger.info(f\"  Agents updated: {result['agents_updated']}\")\r\n            logger.info(f\"  Total documents: {sum(r.get('documents_added_to_rag', 0) for r in result['results'])}\")\r\n            \r\n        except Exception as e:\r\n            logger.error(f\"✗ Learning job failed: {e}\")\r\n            \r\n            # ذخیره لاگ خطا\r\n            self._save_log({\r\n                'timestamp': datetime.now().isoformat(),\r\n                'universities': university_keys,\r\n                'status': 'failed',\r\n                'error': str(e)\r\n            })\r\n    \r\n    def _save_log(self, log_data: Dict):\r\n        \"\"\"ذخیره لاگ\"\"\"\r\n        log_file = self.logs_dir / f\"{datetime.now().strftime('%Y%m%d_%H%M%S')}.json\"\r\n        \r\n        with open(log_file, 'w', encoding='utf-8') as f:\r\n            json.dump(log_data, f, ensure_ascii=False, indent=2)\r\n    \r\n    def start(self):\r\n        \"\"\"شروع scheduler\"\"\"\r\n        if self.is_running:\r\n            logger.warning(\"Scheduler already running\")\r\n            return\r\n        \r\n        logger.info(\"\\n\" + \"=\"*80)\r\n        logger.info(\"  STARTING UNIVERSITY LEARNING SCHEDULER\")\r\n        logger.info(\"=\"*80 + \"\\n\")\r\n        \r\n        # تنظیم job‌ها\r\n        \r\n        # Daily jobs\r\n        for item in self.schedules['daily']:\r\n            schedule.every().day.at(item['time']).do(\r\n                self._learning_job,\r\n                [item['university_key']]\r\n            )\r\n            logger.info(f\"  Daily: {item['university_key']} at {item['time']}\")\r\n        \r\n        # Weekly jobs (Sundays)\r\n        for item in self.schedules['weekly']:\r\n            schedule.every().sunday.at(item['time']).do(\r\n                self._learning_job,\r\n                [item['university_key']]\r\n            )\r\n            logger.info(f\"  Weekly: {item['university_key']} on Sundays at {item['time']}\")\r\n        \r\n        # Monthly jobs (1st of each month)\r\n        for item in self.schedules['monthly']:\r\n            schedule.every().month.at(item['time']).do(\r\n                self._learning_job,\r\n                [item['university_key']]\r\n            )\r\n            logger.info(f\"  Monthly: {item['university_key']} on 1st at {item['time']}\")\r\n        \r\n        logger.info(f\"\\n✓ Scheduler configured\")\r\n        logger.info(f\"  Total jobs: {len(schedule.get_jobs())}\")\r\n        \r\n        # شروع thread\r\n        self.is_running = True\r\n        self.scheduler_thread = threading.Thread(target=self._run_scheduler, daemon=True)\r\n        self.scheduler_thread.start()\r\n        \r\n        logger.info(f\"✓ Scheduler started in background thread\\n\")\r\n    \r\n    def _run_scheduler(self):\r\n        \"\"\"Loop اصلی scheduler\"\"\"\r\n        while self.is_running:\r\n            schedule.run_pending()\r\n            time.sleep(60)  # بررسی هر دقیقه\r\n    \r\n    def stop(self):\r\n        \"\"\"توقف scheduler\"\"\"\r\n        logger.info(\"\\nStopping scheduler...\")\r\n        self.is_running = False\r\n        \r\n        if self.scheduler_thread:\r\n            self.scheduler_thread.join(timeout=5)\r\n        \r\n        schedule.clear()\r\n        logger.info(\"✓ Scheduler stopped\\n\")\r\n    \r\n    def run_now(self, university_keys: list):\r\n        \"\"\"اجرای فوری یک job\"\"\"\r\n        logger.info(f\"\\nRunning immediate learning job...\")\r\n        self._learning_job(university_keys)\r\n    \r\n    def get_next_runs(self) -> list:\r\n        \"\"\"زمان اجرای بعدی job‌ها\"\"\"\r\n        jobs = schedule.get_jobs()\r\n        \r\n        next_runs = []\r\n        for job in jobs:\r\n            next_runs.append({\r\n                'job': str(job.job_func),\r\n                'next_run': job.next_run.isoformat() if job.next_run else None\r\n            })\r\n        \r\n        return next_runs\r\n    \r\n    def get_logs(self, limit: int = 10) -> list:\r\n        \"\"\"دریافت آخرین لاگ‌ها\"\"\"\r\n        log_files = sorted(self.logs_dir.glob('*.json'), reverse=True)[:limit]\r\n        \r\n        logs = []\r\n        for log_file in log_files:\r\n            with open(log_file, 'r', encoding='utf-8') as f:\r\n                logs.append(json.load(f))\r\n        \r\n        return logs\r\n\r\n\r\ndef demo_scheduler():\r\n    \"\"\"دمو scheduler\"\"\"\r\n    from .rag_system import RAGSystem\r\n    \r\n    logger.info(\"\\n\" + \"=\"*80)\r\n    logger.info(\"  SCHEDULER DEMO\")\r\n    logger.info(\"=\"*80 + \"\\n\")\r\n    \r\n    # Initialize\r\n    rag_system = RAGSystem()\r\n    agent_manager = UniversityAgentManager(UNIVERSITIES, AGENT_CONFIG, rag_system)\r\n    scheduler = UniversityLearningScheduler(agent_manager)\r\n    \r\n    # تنظیم زمان‌بندی پیش‌فرض\r\n    scheduler.setup_default_schedules()\r\n    \r\n    # نمایش job‌های بعدی\r\n    logger.info(\"\\nNext scheduled runs:\")\r\n    next_runs = scheduler.get_next_runs()\r\n    for run in next_runs[:5]:\r\n        logger.info(f\"  {run['job']}: {run['next_run']}\")\r\n    \r\n    # اجرای فوری یک job برای تست\r\n    logger.info(\"\\n\\nRunning immediate test job (MIT)...\")\r\n    scheduler.run_now(['MIT'])\r\n    \r\n    # نمایش لاگ‌ها\r\n    logger.info(\"\\n\\nRecent logs:\")\r\n    logs = scheduler.get_logs(limit=3)\r\n    for log in logs:\r\n        logger.info(f\"\\n  {log['timestamp']}:\")\r\n        logger.info(f\"    Status: {log['status']}\")\r\n        logger.info(f\"    Universities: {', '.join(log['universities'])}\")\r\n    \r\n    logger.info(\"\\n\" + \"=\"*80)\r\n    logger.info(\"  SCHEDULER DEMO COMPLETE\")\r\n    logger.info(\"=\"*80 + \"\\n\")\r\n    \r\n    logger.info(\"To run scheduler continuously:\")\r\n    logger.info(\"  scheduler.start()\")\r\n    logger.info(\"  # Runs in background thread\")\r\n    logger.info(\"  # Press Ctrl+C to stop\")\r\n    logger.info(\"\")\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    # Setup logging\r\n    logging.basicConfig(\r\n        level=logging.INFO,\r\n        format='%(message)s'\r\n    )\r\n    \r\n    demo_scheduler()\r\n",
    "format": "py"
  }
]